# リファクタリングワークフロー

TDD（Red-Green-Refactor）でリファクタリングを行うワークフローです。
振る舞いを変えずにコードを改善します。

## 使い方

````bash
/wf-refactor リファクタリング対象と目的
```bash

---

## STEP 1: 作業ログ作成

`docs/tasks/ai-logs/YYYY-MM-DD_{slug}.md` に作業ログを作成すること。

**テンプレート:**

```markdown
# {タイトル}

## 概要

{作業内容の説明}

## 作業内容

{実施した内容を記録}

## 検証結果

{テストや動作確認の結果}

---

## 発生した問題・はまったこと

### 問題1: {問題の概要}

**現象**:
**原因**:
**解決策**:
**今後の注意点**:

## 振り返り

### 学んだこと

-

### ドキュメント・ルール更新の提案

| 対象ファイル | 更新内容 |
| ------------ | -------- |
|              |          |
```bash

## STEP 2: 現状分析と方針決定

以下を分析すること:

- 現状の問題点（複雑性、重複、凝集度など）
- リファクタリングの目標
- 変更範囲の特定

## STEP 3: テスト確認

既存のテストが十分にあることを確認すること。
不足している場合は、リファクタリング前にテストを追加すること。
テストが全てパスすることを確認すること。

## STEP 4: リファクタリング実施

方針に従って段階的にリファクタリングを実施すること。
**重要**: 振る舞いを変えないこと。

問題が発生した場合は作業ログに記録すること。

## STEP 5: 検証

以下を順番に実行すること。

### 1. 静的解析

```bash
devbox run lint
```bash

エラーが出た場合は修正すること。

### 2. フォーマット確認

```bash
devbox run format
```bash

変更があった場合はコミットに含めること。

### 3. テスト実行

```bash
# TypeScript
devbox run test:ts

# Dart
devbox run test:dart
```bash

すべてのテストがパスすることを確認すること。

### 4. 動作確認

- AI で確認可能な場合: 動作確認を実施する
- AI で確認不可能な場合: ユーザーに確認を依頼する

## STEP 6: セルフレビュー

作業内容に応じて適切な役割を選択し、その観点でレビューを行うこと。
問題があれば修正し、STEP 5 に戻ること。

追加で以下も確認:

- 振る舞いが変わっていないか
- リファクタリングの目標を達成したか
- 過度な変更をしていないか

**共通の観点:**

- **セキュリティ**: 認証・認可の漏れ、バリデーション不足、機密情報の露出、OWASP Top 10
- **品質・設計**: エッジケース、命名、パフォーマンス、エラーハンドリング、可読性・保守性
- **テスト**: テストケースの十分さ（正常系・異常系・境界値）、テストの意図
- **ミニマリスト**: 余計な変更、不要な抽象化、YAGNI 原則

## STEP 7: 完了

1. 作業ログの「振り返り」セクションを記入すること
2. 必要に応じてドキュメント・ルールを更新すること
3. Git コミットすること
4. ユーザーに完了報告すること
````
